<!-- frontend/product-list.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>好物热卖 - 京西网</title>
    <style>
        body { font-family: sans-serif; background-color: #fef4f4; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; background: white; border: 2px solid #f28b82; border-radius: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { color: #ea4335; font-size: 24px; font-weight: bold; }
        .search-bar { display: flex; flex-grow: 1; margin: 0 40px; }
        .search-bar input { flex-grow: 1; padding: 10px; border: 2px solid #ea4335; border-right: none; border-radius: 8px 0 0 8px; }
        .search-bar button { padding: 10px 20px; background-color: #ea4335; color: white; border: none; cursor: pointer; border-radius: 0 8px 8px 0; }
        .my-favorites-btn { padding: 10px 20px; background: #fce8e6; border: 1px solid #f28b82; border-radius: 8px; cursor: pointer; }
        .controls { margin-bottom: 20px; }
        .controls button { margin-right: 10px; padding: 8px 15px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 5px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .product-card { border: 1px solid #eee; text-align: center; padding-bottom: 10px; cursor: pointer; transition: box-shadow 0.3s; }
        .product-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .product-card img { max-width: 100%; height: auto; }
        .product-card .price { color: #ea4335; font-size: 20px; font-weight: bold; }
        .product-card .name { font-size: 14px; color: #333; height: 40px; overflow: hidden; }
        .product-card .favorite { color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span class="logo">京西！好物热卖！</span>
            <div class="search-bar">
                <input type="text" placeholder="搜索商品">
                <button>搜索</button>
            </div>
            <a href="favorites.html" class="my-favorites-btn">我的收藏</a>
        </div>
        <div class="controls">
            <button>高级选项</button>
            <button id="sort-asc-btn">价格升序</button>
            <button id="sort-desc-btn">价格降序</button>
        </div>
        <div class="product-grid" id="product-grid">
            <!-- 商品将通过JS动态插入这里 -->
        </div>
    </div>

       <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        const productGrid = document.getElementById('product-grid');

        // --- 核心功能函数 ---

        async function fetchProducts(sortBy = '') {
            let url = `${API_BASE_URL}/products`;
            if (sortBy) {
                url += `?sort_by=${sortBy}`;
            }
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const products = await response.json();
                renderProducts(products);
            } catch (error) {
                console.error('获取商品失败:', error);
                productGrid.innerHTML = '<p>加载商品失败，请检查后端服务是否可用，或刷新页面重试。</p>';
            }
        }

        function renderProducts(products) {
            productGrid.innerHTML = ''; // 清空现有内容
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                // 将产品ID存储在卡片的data属性中，方便事件处理器获取
                card.dataset.productId = product.id; 
            
                card.innerHTML = `
                    <img src="https://via.placeholder.com/200x200.png?text=Product+Image" alt="${product.name}">
                    <p class="price">¥ ${product.price}</p>
                    <p class="name">${product.name}</p>
                    <button class="favorite-btn" data-product-id="${product.id}">收藏 ☆</button>
                `;
                productGrid.appendChild(card);
            });
        }

        // --- 收藏夹逻辑 ---

        async function addFavorite(productId) {
            const userId = sessionStorage.getItem('userId');
            // 1. 增加前端校验
            if (!userId) {
                alert('请先登录！');
                window.location.href = '/login.html';
                return;
            }
            if (!productId) {
                alert('无法收藏，商品ID无效。');
                console.error("Product ID is null or undefined.");
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/favorites/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                    // POST 请求即使没有 body，也最好发送 Content-Type 头
                });
                // 2. 改进错误处理
                if (response.ok) { // response.ok 检查状态码是否在 200-299 范围
                    alert('商品已成功添加到收藏夹！');
                } else {
                    // 解析后端返回的 JSON 错误信息
                    const errorData = await response.json();
                    // FastAPI 的验证错误 detail 是个数组，普通错误 detail 是字符串
                    if (errorData.detail && typeof errorData.detail === 'string') {
                        alert(`收藏失败: ${errorData.detail}`);
                    } else {
                        // 对于复杂的验证错误，给出一个通用提示，并在控制台打印详细信息
                        alert('收藏失败，请求参数有误。');
                        console.error('收藏失败，后端返回的详细错误:', errorData);
                    }
                }
            } catch (error) {
                console.error('收藏请求的网络连接失败:', error);
                alert('无法连接到服务器，请稍后再试。');
            }
        }

        // --- 事件监听器 ---

        // 1. 页面加载完成后，获取商品
        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
        });
        
        // 2. 为排序按钮添加事件监听
        document.getElementById('sort-asc-btn').addEventListener('click', () => fetchProducts('price_asc'));
        document.getElementById('sort-desc-btn').addEventListener('click', () => fetchProducts('price_desc'));

        // 3. 使用事件委托处理所有在 productGrid 内部的点击事件
        productGrid.addEventListener('click', function(event) {
            const target = event.target;
            const card = target.closest('.product-card');

            if (!card) return; // 如果点击的不是卡片内部，则不处理

            const productId = card.dataset.productId;

            // 判断点击的是否是收藏按钮
            if (target.classList.contains('favorite-btn')) {
                // 是收藏按钮：执行收藏逻辑
                addFavorite(productId);
            } else {
                // 不是收藏按钮（即点击卡片的其他部分）：执行跳转逻辑
                window.location.href = `/product-detail.html?id=${productId}`;
            }
        });

    </script>
</body>
</html>