<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的收藏 - 京西网</title>
    <!-- 样式保持你的原样 -->
    <style>
        body { font-family: sans-serif; background-color: #fef4f4; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; background: white; border: 2px solid #f28b82; border-radius: 10px; min-height: 80vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f28b82; padding-bottom: 15px;}
        .logo { color: #ea4335; font-size: 24px; font-weight: bold; }
        .back-link { padding: 10px 20px; background: #fce8e6; border: 1px solid #f28b82; border-radius: 8px; cursor: pointer; text-decoration: none; color: #c53727;}
        .favorites-list { display: flex; flex-direction: column; gap: 20px; }
        .favorite-item { display: flex; align-items: center; border: 1px solid #eee; padding: 15px; border-radius: 8px; transition: box-shadow 0.3s; }
        .favorite-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .favorite-item img { width: 120px; height: 120px; object-fit: cover; margin-right: 20px; border-radius: 5px; }
        .item-details { flex-grow: 1; }
        .item-details h3 { margin: 0 0 10px; }
        .item-details .price { color: #ea4335; font-size: 20px; font-weight: bold; }
        .remove-btn { padding: 8px 15px; background-color: #fff; color: #ea4335; border: 1px solid #ea4335; border-radius: 5px; cursor: pointer; }
        .empty-message { text-align: center; color: #888; font-size: 18px; padding: 100px 0;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span class="logo">我的收藏</span>
            <a href="/product-list.html" class="back-link">返回商品列表</a>
        </div>
        <div id="favorites-list" class="favorites-list"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        const favoritesContainer = document.getElementById('favorites-list');

        async function loadFavorites() {
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                favoritesContainer.innerHTML = '<div class="empty-message">请先<a href="/login.html">登录</a>查看您的收藏。</div>';
                return;
            }
        
            try {
                // 修复点：URL 不再包含 userId
                const response = await fetch(`${API_BASE_URL}/users/favorites`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401) {
                    favoritesContainer.innerHTML = '<div class="empty-message">登录已过期，请重新<a href="/login.html">登录</a>。</div>';
                    return;
                }

                if (!response.ok) throw new Error('Failed to load favorites');
                
                const products = await response.json();
                favoritesContainer.innerHTML = '';
            
                if (products.length === 0) {
                    favoritesContainer.innerHTML = '<div class="empty-message">您的收藏夹还是空的，快去逛逛吧！</div>';
                    return;
                }
            
                products.forEach(product => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'favorite-item';
                    itemElement.id = `favorite-item-${product.id}`;
                    itemElement.innerHTML = `
                        <img src="https://via.placeholder.com/120x120.png?text=Product" alt="${product.name}">
                        <div class="item-details">
                            <h3>${product.name}</h3>
                            <p>${product.description}</p>
                            <span class="price">¥ ${product.price}</span>
                        </div>
                        <button class="remove-btn" data-product-id="${product.id}">删除收藏</button>
                    `;
                    favoritesContainer.appendChild(itemElement);
                });
            } catch (error) {
                console.error('加载收藏失败:', error);
                favoritesContainer.innerHTML = '<div class="empty-message">加载收藏失败，请稍后再试。</div>';
            }
        }

        async function removeFavorite(productId) {
            const token = sessionStorage.getItem('accessToken');
            if (!token) return;
        
            try {
                // 修复点：URL 不再包含 userId
                const response = await fetch(`${API_BASE_URL}/users/favorites/${productId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const itemToRemove = document.getElementById(`favorite-item-${productId}`);
                    if (itemToRemove) itemToRemove.remove();
                    if (favoritesContainer.children.length === 0) {
                        favoritesContainer.innerHTML = '<div class="empty-message">您的收藏夹还是空的，快去逛逛吧！</div>';
                    }
                } else {
                    alert('删除失败！');
                }
            } catch (error) {
                console.error('删除请求失败:', error);
            }
        }

        favoritesContainer.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('remove-btn')) {
                const productId = event.target.getAttribute('data-product-id');
                if (confirm('您确定要从收藏夹中移除此商品吗？')) {
                    removeFavorite(productId);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', loadFavorites);
    </script>
</body>
</html>