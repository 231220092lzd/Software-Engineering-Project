<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å•†å“è¯¦æƒ… - äº¬è¥¿ç½‘</title>
    <style>
        body { font-family: sans-serif; background-color: #fef4f4; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background: white; border: 2px solid #f28b82; border-radius: 10px; display: flex; gap: 40px; }
        
        /* å·¦ä¾§å•†å“ä¿¡æ¯ */
        .product-info { flex: 1; }
        .product-info img { max-width: 100%; border: 1px solid #eee; border-radius: 8px; }
        .product-info h1 { font-size: 24px; margin-top: 15px; }
        .product-info .price { color: #ea4335; font-size: 28px; font-weight: bold; margin: 10px 0; }
        .product-actions { margin-top: 20px; }
        .product-actions button { padding: 15px 30px; font-size: 18px; margin-right: 15px; border-radius: 8px; cursor: pointer; transition: opacity 0.2s; }
        .product-actions button:hover { opacity: 0.9; }
        .buy-btn { background-color: #ea4335; color: white; border: none; }
        .fav-btn { background-color: #fce8e6; border: 1px solid #f28b82; color: #ea4335; }

        /* å³ä¾§è¯„è®ºåŒº */
        .reviews { flex: 1; border-left: 1px solid #eee; padding-left: 40px; display: flex; flex-direction: column; }
        .reviews-header { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 2px solid #ea4335; padding-bottom: 10px; margin-bottom: 15px; }
        
        /* æ–°å¢ï¼šå‘è¡¨è¯„è®ºåŒºåŸŸæ ·å¼ */
        .add-comment-box { background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .add-comment-box h4 { margin-top: 0; margin-bottom: 10px; color: #333; }
        .add-comment-box textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-family: sans-serif; resize: vertical; }
        .add-comment-box .btn-row { text-align: right; margin-top: 10px; }
        .submit-comment-btn { background-color: #ea4335; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
        .login-tip { font-size: 14px; color: #666; text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px; margin-bottom: 20px;}
        .login-tip a { color: #ea4335; text-decoration: none; font-weight: bold; }

        /* è¯„è®ºåˆ—è¡¨æ ·å¼ */
        #review-list { flex-grow: 1; overflow-y: auto; max-height: 600px; }
        .review-card { border-bottom: 1px solid #eee; padding: 15px 0; }
        .review-card:last-child { border-bottom: none; }
        .review-card p { margin: 8px 0; line-height: 1.5; }
        .review-author { display: flex; align-items: center; color: #555; font-size: 14px; }
        .review-author .avatar { width: 30px; height: 30px; border-radius: 50%; background: #e0e0e0; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; }
        .review-reply { font-size: 13px; color: #666; background: #f0f0f0; padding: 8px 12px; margin-top: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ï¼šå•†å“è¯¦æƒ… -->
        <div class="product-info">
            <h3 style="color:#ea4335">äº¬è¥¿ï¼å¥½ç‰©çƒ­å–ï¼</h3>
            <img id="product-image" src="https://via.placeholder.com/400x400.png?text=Loading..." alt="å•†å“å›¾ç‰‡">
            <h1 id="product-name">åŠ è½½ä¸­...</h1>
            <p id="product-description">...</p>
            <p class="price" id="product-price">Â¥ ...</p>
            <div class="product-actions">
                <button class="buy-btn" onclick="alert('åŠŸèƒ½å¼€å‘ä¸­...')">ç«‹å³è´­ä¹°</button>
                <button id="add-to-favorites-btn" class="fav-btn">â˜† æ”¶è—</button>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè¯„è®ºåŒº -->
        <div class="reviews">
            <div class="reviews-header">
                <h2>ä¹°å®¶è¯„ä»·</h2>
                <span id="review-count">å…± 0 æ¡</span>
            </div>

            <!-- æ–°å¢ï¼šå‘è¡¨è¯„è®ºè¡¨å• -->
            <div id="comment-form-section">
                <!-- å¦‚æœå·²ç™»å½•æ˜¾ç¤ºè¿™ä¸ª -->
                <div id="logged-in-form" class="add-comment-box" style="display: none;">
                    <h4>å‘è¡¨æ‚¨çš„è¯„ä»·</h4>
                    <textarea id="comment-content" placeholder="å•†å“æ˜¯å¦æ»¡è¶³æ‚¨çš„æœŸå¾…ï¼Ÿè¯´è¯´æ‚¨çš„ä½¿ç”¨å¿ƒå¾—..."></textarea>
                    <div class="btn-row">
                        <button id="submit-comment-btn" class="submit-comment-btn">å‘å¸ƒè¯„è®º</button>
                    </div>
                </div>
                <!-- å¦‚æœæœªç™»å½•æ˜¾ç¤ºè¿™ä¸ª -->
                <div id="logged-out-tip" class="login-tip">
                    <a href="/login.html">ç™»å½•</a> åå³å¯å‘è¡¨è¯„è®º
                </div>
            </div>

            <div id="review-list">
                <!-- è¯„è®ºåˆ—è¡¨ JS å¡«å…… -->
                <p>æ­£åœ¨åŠ è½½è¯„è®º...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        const reviewList = document.getElementById('review-list');
        const token = sessionStorage.getItem('accessToken');
        const userId = sessionStorage.getItem('userId');

        // --- 1. åˆå§‹åŒ–é¡µé¢çŠ¶æ€ (æ£€æŸ¥ç™»å½•) ---
        function checkLoginStatus() {
            const loggedInForm = document.getElementById('logged-in-form');
            const loggedOutTip = document.getElementById('logged-out-tip');

            if (token) {
                loggedInForm.style.display = 'block';
                loggedOutTip.style.display = 'none';
            } else {
                loggedInForm.style.display = 'none';
                loggedOutTip.style.display = 'block';
            }
        }

        // --- 2. è·å–å•†å“è¯¦æƒ… ---
        async function fetchProductDetails(productId) {
            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}`);
                if (!response.ok) throw new Error('Product not found');
                const product = await response.json();

                document.getElementById('product-name').textContent = product.name;
                document.getElementById('product-description').textContent = product.description;
                document.getElementById('product-price').textContent = `Â¥ ${product.price}`;
                
                // è®¾ç½®å›¾ç‰‡ (å¦‚æœæœ‰image_urlåˆ™ä½¿ç”¨ï¼Œå¦åˆ™ç”¨å ä½å›¾)
                const imgUrl = product.image_url && product.image_url.startsWith('http') 
                    ? product.image_url 
                    : `https://via.placeholder.com/400x400.png?text=${encodeURIComponent(product.name)}`;
                document.getElementById('product-image').src = imgUrl;

                document.getElementById('add-to-favorites-btn').setAttribute('data-product-id', product.id);

                // è·å–è¯„è®º
                fetchReviews(product.id);
            } catch (error) {
                console.error('Error:', error);
                document.querySelector('.product-info').innerHTML = '<h1>æœªæ‰¾åˆ°å•†å“ä¿¡æ¯</h1>';
            }
        }

        // --- 3. è·å–å¹¶æ¸²æŸ“è¯„è®º ---
        async function fetchReviews(productId) {
            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}/comments`);
                const reviews = await response.json();
                
                document.getElementById('review-count').textContent = `å…± ${reviews.length} æ¡`;
                renderReviews(reviews);
            } catch (error) {
                console.error('è·å–è¯„è®ºå¤±è´¥:', error);
                reviewList.innerHTML = '<p>åŠ è½½è¯„è®ºå¤±è´¥ã€‚</p>';
            }
        }

        function renderReviews(reviews) {
            reviewList.innerHTML = '';
            if (reviews.length === 0) {
                 reviewList.innerHTML = '<p style="color:#999; text-align:center; margin-top:20px;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>';
                 return;
            }
            // å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨å‰é¢
            reviews.reverse().forEach(review => {
                const card = document.createElement('div');
                card.className = 'review-card';
                
                // ä¼˜å…ˆæ˜¾ç¤º usernameï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤º ID
                const displayName = review.username || `ç”¨æˆ· ${review.user_id}`;
                //ä»¥æ­¤ç”Ÿæˆä¸€ä¸ªç®€å•çš„å¤´åƒé¦–å­—æ¯
                const avatarChar = displayName.charAt(0).toUpperCase();

                card.innerHTML = `
                    <div class="review-author">
                        <div class="avatar">${avatarChar}</div>
                        <span>${displayName}</span>
                    </div>
                    <p>${review.content}</p>
                    ${review.likes > 0 ? `<div style="font-size:12px; color:#999;">ğŸ‘ ${review.likes} äººè§‰å¾—å¾ˆèµ</div>` : ''}
                `;
                reviewList.appendChild(card);
            });
        }

        // --- 4. æäº¤è¯„è®ºåŠŸèƒ½ ---
        async function submitComment(productId) {
            const contentInput = document.getElementById('comment-content');
            const content = contentInput.value.trim();

            if (!content) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹ï¼');
                return;
            }
            if (content.length < 5) {
                alert('è¯„è®ºå†…å®¹è‡³å°‘éœ€è¦5ä¸ªå­—å“¦ã€‚');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // å¿…é¡»å¸¦ Token
                    },
                    body: JSON.stringify({ content: content })
                });

                if (response.status === 201) {
                    alert('è¯„è®ºå‘å¸ƒæˆåŠŸï¼');
                    contentInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    fetchReviews(productId); // åˆ·æ–°è¯„è®ºåˆ—è¡¨
                } else {
                    const error = await response.json();
                    alert(`å‘å¸ƒå¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('å‘å¸ƒè¯„è®ºé”™è¯¯:', error);
                alert('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
        }

        // --- 5. æ”¶è—åŠŸèƒ½ ---
        async function addFavorite(productId) {
            if (!token) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = '/login.html';
                return;
            }
            try {
                // æ³¨æ„ï¼šè¿™é‡Œ URL å·²ç»å»æ‰äº† userId
                const response = await fetch(`${API_BASE_URL}/users/favorites/${productId}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token}` 
                    }
                });
                if (response.ok) {
                    alert('å·²æ”¶è—ï¼');
                } else {
                    const error = await response.json();
                    alert(`æ”¶è—å¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥');
            }
        }

        // --- äº‹ä»¶ç›‘å¬ä¸åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus(); // 1. æ£€æŸ¥ç™»å½•æ€æ˜¾ç¤ºä¸åŒç•Œé¢

            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            if (productId) {
                fetchProductDetails(productId); // 2. åŠ è½½å•†å“å’Œè¯„è®º

                // ç»‘å®šå‘è¡¨è¯„è®ºæŒ‰é’®äº‹ä»¶
                document.getElementById('submit-comment-btn').addEventListener('click', () => {
                    submitComment(productId);
                });
            } else {
                document.querySelector('.container').innerHTML = '<h1>å‚æ•°é”™è¯¯</h1>';
            }
        });

        // ç»‘å®šæ”¶è—æŒ‰é’®äº‹ä»¶
        document.getElementById('add-to-favorites-btn').addEventListener('click', function() {
            const pid = this.getAttribute('data-product-id');
            if(pid) addFavorite(pid);
        });

    </script>
</body>
</html>